



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="An introduction to using AWS KMS and the AWS Encryption SDK">
      
      
        <link rel="canonical" href="https://awssecworkshops.com/encryption-context/">
      
      
        <meta name="author" content="aws-cryptools@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.0">
    
    
      
        <title>Working With Encryption Context - Busy Engineer's Document Bucket Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#exercise-3-working-with-encryption-context" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Busy Engineer's Document Bucket Workshop
                </span>
                <span class="md-header-nav__topic">
                  Working With Encryption Context
                </span>
              
            
          </div>
        </div>
  
        <!-- Button to open search dialogue -->
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              <!-- Search interface -->
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>
        
        <!-- Repository containing source -->
        
        <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__lang">
                <div class="md-lang-drop">
                    <button onclick="window.location.href = 'https://awssecworkshops.com';" class="md-lang-dropbtn fa fa-globe"></button>
                </div>
            </div>
        </div>

        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../add-the-encryption-sdk/" class="md-tabs__link md-tabs__link--active">
          Exercises
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://awssecworkshops.com" title="Busy Engineer's Document Bucket Workshop" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Busy Engineer's Document Bucket Workshop
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Exercises
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../add-the-encryption-sdk/" title="Add the Encryption SDK" class="md-nav__link">
      Add the Encryption SDK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multi-cmk/" title="Using Multiple CMKs" class="md-nav__link">
      Using Multiple CMKs
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Working With Encryption Context
      </label>
    
    <a href="./" title="Working With Encryption Context" class="md-nav__link md-nav__link--active">
      Working With Encryption Context
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-kms-cryptography-and-encryption-context" class="md-nav__link">
    AWS KMS: Cryptography and encryption context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-kms-policy-and-audit-hooks" class="md-nav__link">
    AWS KMS: Policy and Audit Hooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-aws-encryption-sdk" class="md-nav__link">
    The AWS Encryption SDK
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-in-the-document-bucket" class="md-nav__link">
    Use in the Document Bucket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-set-encryption-context-on-encrypt" class="md-nav__link">
    Step 1: Set encryption context on Encrypt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-use-encryption-context-on-decrypt" class="md-nav__link">
    Step 2: Use encryption context on Decrypt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-making-assertions" class="md-nav__link">
    Step 3: Making Assertions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../thank-you-and-closing/" title="Thank You and Closing" class="md-nav__link">
      Thank You and Closing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-kms-cryptography-and-encryption-context" class="md-nav__link">
    AWS KMS: Cryptography and encryption context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-kms-policy-and-audit-hooks" class="md-nav__link">
    AWS KMS: Policy and Audit Hooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-aws-encryption-sdk" class="md-nav__link">
    The AWS Encryption SDK
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-in-the-document-bucket" class="md-nav__link">
    Use in the Document Bucket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-set-encryption-context-on-encrypt" class="md-nav__link">
    Step 1: Set encryption context on Encrypt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-use-encryption-context-on-decrypt" class="md-nav__link">
    Step 2: Use encryption context on Decrypt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-making-assertions" class="md-nav__link">
    Step 3: Making Assertions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/busy-engineers-document-bucket/edit/master/docs/encryption-context.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="exercise-3-working-with-encryption-context">Exercise 3: Working With Encryption Context</h1>
<p>In this section, you will work with encryption context and explore its use in the Document Bucket and other applications.</p>
<h2 id="background">Background</h2>
<p>The Busy Engineer's Document Bucket has metadata, called <code>context</code>, associated with each document. This meatadata is a set of key-value string pairs, associated with the item in DynamoDB, searchable there, and attached to the S3 object as well.</p>
<p>One of the features AWS KMS and the AWS Encryption SDK both provide is called encryption context. At its core, encryption context is this metadata mapping: keys that are associated with context about the object, and values indicating information about what that context is. All the information in the map is non-secret, and is the basis for several feature integrations.</p>
<p>One useful model for thinking about encryption context is as Assertions about the <a href="https://en.wikipedia.org/wiki/Five_Ws" target="_blank">Five Ws</a>: Who, What, Where, When, Why. For example:</p>
<ul>
<li><em>Who</em> should have access to this decrypted data?</li>
<li><em>What</em> data is being decrypted?</li>
<li><em>Where</em> is the decryption happening?</li>
<li><em>When</em> is this data being used?</li>
<li><em>Why</em> is this data being decrypted?</li>
</ul>
<h3 id="aws-kms-cryptography-and-encryption-context">AWS KMS: Cryptography and encryption context</h3>
<p>AWS KMS allows you to specify an encryption context on <code>kms:Encrypt</code>. If you do so, you must provide the exact same encryption context on <code>kms:Decrypt</code>, or the operation will fail. (The match is case-sensitive, and key-value pairs are compared in an order independent way.)</p>
<p>Behind the scenes, KMS is cryptographically binding the encryption context to the key material you are <code>kms:Encrypt</code> or <code>kms:Decrypt</code>ing as <em>Additional Authenticated Data (AAD)</em>. In short, this is non-secret data that must be identical (not tampered-with or incomplete), or decryption fails.</p>
<p>This feature defends against risks from ciphertexts being tampered with, modified, or replaced -- intentionally or unintentionally. It both defends against an attacker replacing one ciphertext with another as well as problems like operational events.</p>
<p>For example, if a bad deployment swaps <code>us-west-2.cfg</code> with <code>eu-central-1.cfg</code> on your fleets, having <code>{ fleet: us-west-2 }</code> asserted in <code>us-west-2.cfg</code>'s encryption context will prevent it from accidentally being loaded by <code>eu-central-1</code>.</p>
<h3 id="aws-kms-policy-and-audit-hooks">AWS KMS: Policy and Audit Hooks</h3>
<p>KMS also makes the encryption context available to use in Key Policies and Grants. This means that you can use assertions you make about your data to control usage of your CMKs. Perhaps your <code>eu-central-1</code> fleet should only ever be permitted to access encrypted data for <code>{ shard: europe }</code>. You can write CMK policies that require <code>{ shard: europe }</code> to be asserted about all cryptographic operations, so that KMS refuses to authorize an attempt to decrypt, say, <code>{ shard: north-america }</code>. These options can help you secure your application and defend against both operational and security-related risks.</p>
<p>Additionally, as part of the audit features that KMS provides, it logs the encryption context that was supplied with every operation. You can use this information to audit who was accessing what data and when, to detect anomalous call patterns, or to identify unexpected system states.</p>
<p>What questions would you like to answer with CloudTrail Logs for your KMS operations? encryption context can help.</p>
<h3 id="the-aws-encryption-sdk">The AWS Encryption SDK</h3>
<p>The AWS Encryption SDK includes the encryption context as a core component. Encryption context <em>may</em> be supplied on encrypt -- it is optional, both for the Encryption SDK and for KMS, but strongly recommended.</p>
<p>The Encryption SDK writes the encryption context in the encrypted message format. And on decrypt, the Encryption SDK validates the encryption context with KMS and returns the contents to you for you to make assertions about the contents.</p>
<p>Using the Encryption SDK with KMS, you can use all of KMS' policy and audit features from encryption context, and use the Encryption SDK to make assertions to safeguard your application.</p>
<h3 id="use-in-the-document-bucket">Use in the Document Bucket</h3>
<p>So how can encryption context be useful in the Document Bucket?</p>
<p>In this exercise, you will walk through a few examples of how leveraging encryption context can help you secure and audit your application, and even build some convenience features.</p>
<p>The Document Bucket already has the <code>context</code> map available for operations. It writes the <code>context</code> to the DynamoDB records for objects as well, and generates searchable DynamoDB records for context keys, to let you find documents that have certain attributes.</p>
<p>Now you will plumb that context through the AWS Encryption SDK, so that KMS and the Encryption SDK bind those properties as security assertions about your data. You will also add an assertion facility to ensure that your data is what you expect it to be when you call <code>retrieve</code>.</p>
<p>What this means is that with this change, you will be able to use encryption context to defend against these kind of risks:</p>
<ul>
<li>DynamoDB record updates that create metadata mismatches between a document and its properties</li>
<li>Swapping objects in S3 so that the data is no longer what it was expected to be</li>
<li>Accidentally loading the wrong data blob</li>
<li>Defending against objects being listed as having a certain context key / property when they actually do not</li>
</ul>
<p>Also, after this change, the contents of <code>context</code> will be available in audit log entries written by KMS, and you can now use that metadata in your Key Policies and Grants.</p>
<p>Remember, encryption context is not secret!</p>
<h2 id="make-the-change">Make the Change</h2>
<h3 id="starting-directory">Starting Directory</h3>
<p>If you just finished <a href="../multi-cmk/">Using Multiple CMKs</a>, you are all set.</p>
<p>If you aren't sure, or want to catch up, jump into the <code>encryption-context-start</code> directory for the language of your choice.</p>
<div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked" />
<label for="__tab_1_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/java/encryption-context-start
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_1" />
<label for="__tab_1_1">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/node-typescript/encryption-context-start
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_2" />
<label for="__tab_1_2">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/node-javascript/encryption-context-start
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_3" />
<label for="__tab_1_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/python/encryption-context-start
</pre></div>
</td></tr></table></div>
</div>
<h3 id="step-1-set-encryption-context-on-encrypt">Step 1: Set encryption context on Encrypt</h3>
<div class="superfences-tabs">
<input name="__tabs_2" type="radio" id="__tab_2_0" checked="checked" />
<label for="__tab_2_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">// Edit Api.java and find store(...)</span>
    <span class="c1">// ENCRYPTION-CONTEXT-START: Set Encryption Context on Encrypt</span>
    <span class="n">CryptoResult</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="n">KmsMasterKey</span><span class="o">&gt;</span> <span class="n">encryptedMessage</span> <span class="o">=</span>
<span class="hll">        <span class="n">awsEncryptionSdk</span><span class="o">.</span><span class="na">encryptData</span><span class="o">(</span><span class="n">mkp</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span>    <span class="n">DocumentBundle</span> <span class="n">bundle</span> <span class="o">=</span>
<span class="hll">        <span class="n">DocumentBundle</span><span class="o">.</span><span class="na">fromDataAndContext</span><span class="o">(</span><span class="n">encryptedMessage</span><span class="o">.</span><span class="na">getResult</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>```javascript tab="JavaScript Node.JS" hl_lines=" 3 4 5"
  // Edit store.js
  // ENCRYPTION-CONTEXT-COMPLETE: Set encryption context on Encrypt
  const Body = fileStream.pipe(
    encryptStream(encryptKeyring, { encryptionContext })
  );</p>
<p>// Save your changes
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">```</span><span class="n">typescript</span> <span class="n">tab</span><span class="o">=</span><span class="ss">&quot;Typescript Node.JS&quot;</span> <span class="n">hl_lines</span><span class="o">=</span><span class="ss">&quot; 3 4 5&quot;</span>
  <span class="o">//</span> <span class="n">Edit</span> <span class="n">src</span><span class="o">/</span><span class="n">store</span><span class="p">.</span><span class="n">ts</span>
  <span class="o">//</span> <span class="n">ENCRYPTION</span><span class="o">-</span><span class="n">CONTEXT</span><span class="o">-</span><span class="n">COMPLETE</span><span class="p">:</span> <span class="k">Set</span> <span class="n">encryption</span> <span class="n">context</span> <span class="k">on</span> <span class="n">Encrypt</span>
  <span class="n">const</span> <span class="n">Body</span> <span class="o">=</span> <span class="n">fileStream</span><span class="p">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">encryptStream</span><span class="p">(</span><span class="n">encryptKeyring</span><span class="p">,</span> <span class="err">{</span> <span class="n">encryptionContext</span> <span class="err">}</span><span class="p">)</span>
  <span class="p">);</span>

<span class="o">//</span> <span class="n">Save</span> <span class="n">your</span> <span class="n">changes</span>
</pre></div>
</td></tr></table></p>
<div class="superfences-tabs">
<input name="__tabs_3" type="radio" id="__tab_3_0" checked="checked" />
<label for="__tab_3_0">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/api.py</span>
<span class="c1"># Find the store(...) function, and add context to the encrypt call</span>

<span class="c1"># ENCRYPTION-CONTEXT-START: Set encryption context on Encrypt</span>
<span class="n">encrypted_data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">aws_encryption_sdk</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="n">source</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">key_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">master_key_provider</span><span class="p">,</span>
<span class="hll">    <span class="n">encryption_context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="c1"># Save your changes</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened">What Just Happened</h4>
<p>The Document Bucket <code>context</code> will now be supplied to the AWS Encryption SDK and AWS KMS as encryption context. If a non-empty key-value pair map is supplied to <code>store</code>, those key-value pairs will be used in encryption and decryption operations all the way through to KMS:</p>
<ul>
<li>The contents of <code>context</code> will appear in KMS audit logs.</li>
<li>The contents of <code>context</code> will be availble to use in KMS Key Policies and Grants to make authorization decisions.</li>
<li>The contents of <code>context</code> will be written to the Encryption SDK message.</li>
<li>Supplying the exact-match contents of <code>context</code> will be required to decrypt any encrypted data keys.</li>
<li>The contents of <code>context</code> will now be available on Decrypt to use in making assertions.</li>
</ul>
<p>Next you will update <code>retrieve</code> to use the encryption context on decrypt.</p>
<h3 id="step-2-use-encryption-context-on-decrypt">Step 2: Use encryption context on Decrypt</h3>
<div class="superfences-tabs">
<input name="__tabs_4" type="radio" id="__tab_4_0" checked="checked" />
<label for="__tab_4_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">// Edit Api.java and find retrieve(...)</span>
    <span class="c1">// ENCRYPTION-CONTEXT-START: Use Encryption Context on Decrypt</span>
<span class="hll">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">actualContext</span> <span class="o">=</span> <span class="n">decryptedMessage</span><span class="o">.</span><span class="na">getEncryptionContext</span><span class="o">();</span>
</span><span class="hll">    <span class="n">PointerItem</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">PointerItem</span><span class="o">.</span><span class="na">fromKeyAndContext</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">actualContext</span><span class="o">);</span>
</span></pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_1" />
<label for="__tab_4_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit retrieve.js</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">s3</span>
      <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">))</span>
      <span class="c1">// ENCRYPTION-CONTEXT-COMPLETE: Making Assertions</span>
<span class="hll">      <span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;MessageHeader&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="p">})</span>
</span>  <span class="p">);</span>

<span class="c1">// Save your changes</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_2" />
<label for="__tab_4_2">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit src/retrieve.js</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">s3</span>
      <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">))</span>
      <span class="c1">// ENCRYPTION-CONTEXT-COMPLETE: Making Assertions</span>
<span class="hll">      <span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;MessageHeader&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">Writable</span><span class="p">,</span> <span class="nx">header</span>: <span class="kt">MessageHeader</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="p">})</span>
</span>  <span class="p">);</span>
<span class="c1">// Save your changes</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_3" />
<label for="__tab_4_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/api.py</span>
<span class="c1"># Find the retrieve(...) function, and use the Encryption SDK header&#39;s encryption</span>
<span class="c1"># context to construct the DocumentBundle to return</span>

<span class="c1"># ENCRYPTION-CONTEXT-START: Use encryption context on Decrypt</span>
<span class="k">return</span> <span class="n">DocumentBundle</span><span class="o">.</span><span class="n">from_data_and_context</span><span class="p">(</span>
<span class="hll">    <span class="n">plaintext</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">encryption_context</span>
</span><span class="p">)</span>
<span class="c1"># Save your changes</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened_1">What Just Happened</h4>
<p>Now on decrypt, the validated encryption context from the Encryption SDK Message Format header will be passed back to the application. Any business logic that would benefit from using the encryption context data for making decisions can use the version bound and validated by the Encryption SDK and KMS.</p>
<p>Next you will add a mechanism for the application to test assertions made in encryption context before working with the returned data.</p>
<h3 id="step-3-making-assertions">Step 3: Making Assertions</h3>
<div class="superfences-tabs">
<input name="__tabs_5" type="radio" id="__tab_5_0" checked="checked" />
<label for="__tab_5_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">TODO</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_1" />
<label for="__tab_5_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit retrieve.js</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">s3</span>
      <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">))</span>
      <span class="c1">// ENCRYPTION-CONTEXT-COMPLETE: Making Assertions</span>
      <span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;MessageHeader&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">encryptionContext</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">header</span><span class="p">;</span>
</span><span class="hll">        <span class="kr">const</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">expectedContext</span> <span class="o">||</span> <span class="p">{});</span>
</span><span class="hll">        <span class="kr">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nx">expectedContextKeys</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">slice</span><span class="p">();</span>
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span>
</span><span class="hll">          <span class="o">!</span><span class="p">(</span>
</span><span class="hll">            <span class="nx">pairs</span><span class="p">.</span><span class="nx">every</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nx">encryptionContext</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class="hll">            <span class="nx">keys</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">key</span> <span class="p">=&gt;</span>
</span><span class="hll">              <span class="nb">Object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">encryptionContext</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span><span class="hll">            <span class="p">)</span>
</span><span class="hll">          <span class="p">)</span>
</span><span class="hll">        <span class="p">)</span> <span class="p">{</span>
</span><span class="hll">          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
</span><span class="hll">            <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Encryption context does not match expected shape&quot;</span><span class="p">)</span>
</span><span class="hll">          <span class="p">);</span>
</span><span class="hll">        <span class="p">}</span>
</span>      <span class="p">})</span>
  <span class="p">);</span>

<span class="c1">// Save your changes</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_2" />
<label for="__tab_5_2">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit src/retrieve.js</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">s3</span>
      <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">))</span>
      <span class="c1">// ENCRYPTION-CONTEXT-COMPLETE: Making Assertions</span>
      <span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;MessageHeader&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">Writable</span><span class="p">,</span> <span class="nx">header</span>: <span class="kt">MessageHeader</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">encryptionContext</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">header</span><span class="p">;</span>
</span><span class="hll">        <span class="kr">const</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">expectedContext</span> <span class="o">||</span> <span class="p">{});</span>
</span><span class="hll">        <span class="kr">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nx">expectedContextKeys</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">slice</span><span class="p">();</span>
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span>
</span><span class="hll">          <span class="o">!</span><span class="p">(</span>
</span><span class="hll">            <span class="nx">pairs</span><span class="p">.</span><span class="nx">every</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nx">encryptionContext</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class="hll">            <span class="nx">keys</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span>
</span><span class="hll">              <span class="nb">Object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">encryptionContext</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span><span class="hll">            <span class="p">)</span>
</span><span class="hll">          <span class="p">)</span>
</span><span class="hll">        <span class="p">)</span> <span class="p">{</span>
</span><span class="hll">          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
</span><span class="hll">            <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Encryption context does not match expected shape&quot;</span><span class="p">)</span>
</span><span class="hll">          <span class="p">);</span>
</span><span class="hll">        <span class="p">}</span>
</span>      <span class="p">})</span>
  <span class="p">);</span>

<span class="c1">// Save your changes</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_3" />
<label for="__tab_5_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/api.py</span>
<span class="c1"># Find the retrieve(...) function, and add some assertions about the contents</span>
<span class="c1"># of the encryption context validated by the Encryption SDK</span>

<span class="c1"># ENCRYPTION-CONTEXT-START: Making Assertions</span>
<span class="hll"><span class="k">if</span> <span class="ow">not</span> <span class="n">expected_context_keys</span> <span class="o">&lt;=</span> <span class="n">header</span><span class="o">.</span><span class="n">encryption_context</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span>    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Encryption context assertion failed! &quot;</span>
        <span class="n">f</span><span class="s2">&quot;Expected all these keys: {expected_context_keys}, &quot;</span>
        <span class="n">f</span><span class="s2">&quot;but got {header.encryption_context}!&quot;</span>
    <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
<span class="hll"><span class="k">if</span> <span class="ow">not</span> <span class="n">expected_context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">header</span><span class="o">.</span><span class="n">encryption_context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span>    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Encryption context assertion failed! &quot;</span>
        <span class="n">f</span><span class="s2">&quot;Expected {expected_context}, &quot;</span>
        <span class="n">f</span><span class="s2">&quot;but got {header.encryption_context}!&quot;</span>
    <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened_2">What Just Happened</h4>
<p><code>retrieve</code> will use its "expected context keys" argument to validate that all of those keys (with any associated values) are present in the encryption context. <code>retrieve</code> will also use its "expected context" argument to validate that the exact key-value pairs specified in expected context are present in the actual encryption context. If either of those assumptions is invalid, <code>retrieve</code> will raise an exception before returning the data. These assertions safeguard against accidentally returning unintended, corrupted, or tampered data to the application.</p>
<p>Now the Document Bucket will use AWS KMS and the AWS Encryption SDK to ensure that the <code>context</code> metadata is consistent throughout the lifetime of the objects, resistant to tampering or corruption, and make the validated context available to the application logic to make additional business logic assertions safely.</p>
<h3 id="checking-your-work">Checking Your Work</h3>
<p>If you want to check your progress, or compare what you've done versus a finished example, check out the code in one of the <code>-complete</code> folders to compare.</p>
<p>There is a <code>-complete</code> folder for each language.</p>
<div class="superfences-tabs">
<input name="__tabs_6" type="radio" id="__tab_6_0" checked="checked" />
<label for="__tab_6_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/java/encryption-context-complete
</pre></div>
</td></tr></table></div>
<input name="__tabs_6" type="radio" id="__tab_6_1" />
<label for="__tab_6_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/node-javascript/encryption-context-complete
</pre></div>
</td></tr></table></div>
<input name="__tabs_6" type="radio" id="__tab_6_2" />
<label for="__tab_6_2">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/python/encryption-context-complete
</pre></div>
</td></tr></table></div>
</div>
<h2 id="try-it-out">Try it Out</h2>
<div class="superfences-tabs">
<input name="__tabs_7" type="radio" id="__tab_7_0" checked="checked" />
<label for="__tab_7_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TODO
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_1" />
<label for="__tab_7_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">node</span>
<span class="nx">list</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./list.js&quot;</span><span class="p">)</span>
<span class="nx">store</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./store.js&quot;</span><span class="p">)</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">encryptionContext</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">stage</span><span class="o">:</span> <span class="s2">&quot;demo&quot;</span><span class="p">,</span>
  <span class="nx">purpose</span><span class="o">:</span> <span class="s2">&quot;simple demonstration&quot;</span><span class="p">,</span>
  <span class="nx">origin</span><span class="o">:</span> <span class="s2">&quot;us-east-2&quot;</span>
<span class="p">}</span>
<span class="nx">store</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s2">&quot;./store.js&quot;</span><span class="p">),</span> <span class="nx">encryptionContext</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Just storing the s3 key</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Key</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">retrieve</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">{</span> <span class="nx">expectedContext</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stage</span><span class="o">:</span> <span class="s2">&quot;demo&quot;</span><span class="p">},</span> <span class="nx">expectedContextKeys</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;purpose&quot;</span> <span class="p">]</span> <span class="p">}).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span>
<span class="c1">// Ctrl-D when finished to exit the REPL</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_2" />
<label for="__tab_7_2">JavaScript Node.JS CLI</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./cli.js list
./cli.js store ./store.js <span class="se">\</span>
  -c <span class="s2">&quot;stage:demo&quot;</span> <span class="se">\</span>
  -c <span class="s2">&quot;purpose:simple demonstration&quot;</span> <span class="se">\</span>
  -c <span class="s2">&quot;origin:us-east-2&quot;</span>
<span class="c1"># Note the &quot;Key&quot; value</span>
./cli.js list
<span class="c1"># Note the &quot;reference&quot; value</span>
./cli.js retrieve <span class="nv">$KeyOrReferenceValue</span> <span class="se">\</span>
  -c <span class="s2">&quot;stage:demo&quot;</span> <span class="se">\</span>
  -k purpose
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_3" />
<label for="__tab_7_3">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">node</span> <span class="o">-</span><span class="nx">r</span> <span class="nx">ts</span><span class="o">-</span><span class="nx">node</span><span class="o">/</span><span class="nx">register</span>
<span class="p">;({</span><span class="nx">list</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./src/list.ts&quot;</span><span class="p">))</span>
<span class="p">;({</span><span class="nx">store</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./src/store.ts&quot;</span><span class="p">))</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">encryptionContext</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">stage</span><span class="o">:</span> <span class="s2">&quot;demo&quot;</span><span class="p">,</span>
  <span class="nx">purpose</span><span class="o">:</span> <span class="s2">&quot;simple demonstration&quot;</span><span class="p">,</span>
  <span class="nx">origin</span><span class="o">:</span> <span class="s2">&quot;us-east-2&quot;</span>
<span class="p">}</span>
<span class="nx">store</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s2">&quot;./store.js&quot;</span><span class="p">),</span> <span class="nx">encryptionContext</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Just storing the s3 key</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Key</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">retrieve</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">{</span> <span class="nx">expectedContext</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stage</span><span class="o">:</span> <span class="s2">&quot;demo&quot;</span><span class="p">},</span> <span class="nx">expectedContextKeys</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;purpose&quot;</span> <span class="p">]</span> <span class="p">}).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span>
<span class="c1">// Ctrl-D when finished to exit the REPL</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_4" />
<label for="__tab_7_4">Typescript Node.JS CLI</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./cli.ts list
./cli.ts store ./store.js <span class="se">\</span>
  -c <span class="s2">&quot;stage:demo&quot;</span> <span class="se">\</span>
  -c <span class="s2">&quot;purpose:simple demonstration&quot;</span> <span class="se">\</span>
  -c <span class="s2">&quot;origin:us-east-2&quot;</span>
<span class="c1"># Note the &quot;Key&quot; value</span>
./cli.ts list
<span class="c1"># Note the &quot;reference&quot; value</span>
./cli.ts retrieve <span class="nv">$KeyOrReferenceValue</span> <span class="se">\</span>
  -c <span class="s2">&quot;stage:demo&quot;</span> <span class="se">\</span>
  -k purpose
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_5" />
<label for="__tab_7_5">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>TODO
</pre></div>
</td></tr></table></div>
</div>
<h2 id="explore-further">Explore Further</h2>
<p>Encryption context can provide different types of features and guardrails in your application logic. Consider these ideas for further exploration:</p>
<ul>
<li><strong>Detecting Drift</strong> - <code>context</code> contents are stored on the DynamoDB item. S3 has object metadata that could also use the <code>context</code> pairs. How would you use the validated encryption context to validate and guardrail those two data sources? What could that feature add to your application?</li>
<li><strong>Meta-operations on Encryption Context</strong> - the encryption context is stored on the <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/message-format.html" target="_blank">open-specification AWS Encryption SDK Message Format</a>. Would it help your system to write tools to process the metadata -- such as the encryption context -- on the message format?</li>
<li><strong>DynamoDB Keys and Indexes</strong> - the Document Bucket adds composite indexes by <code>context</code> key. What about adding composite keys by key-value pairs? If you know a particular key should always be present in well-formed encrypted data, perhaps that should also be a <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SecondaryIndexes.html" target="_blank">Secondary Index</a>?</li>
<li><strong>Enforing EC Keys</strong> - If you know that there is a key that should always be present, and that you want to index on in DynamoDB, do you want to enforce that it's always present? You can extend the <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/concepts.html#crypt-materials-manager" target="_blank">Cryptographic Materials Manager</a> component in the AWS Encryption SDK to enforce this during cryptographic operations.</li>
<li><strong>Alarms and Monitoring</strong> - How can you leverage encryption context and <a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudwatch-alarms-for-cloudtrail.html" target="_blank">CloudWatch Alarms for CloudTrail</a> to monitor and protect your application?</li>
</ul>
<h1 id="next-exercise">Next exercise</h1>
<p>That's it! You have officially completed the Busy Engineer's Document Bucket workshop. Proceed to <a href="../thank-you-and-closing/">Thank You and Closing</a> for some parting thoughts and information.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../multi-cmk/" title="Using Multiple CMKs" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Using Multiple CMKs
              </span>
            </div>
          </a>
        
        
          <a href="../thank-you-and-closing/" title="Thank You and Closing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Thank You and Closing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a8b5e56f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../javascripts/extra.js"></script>
      
    
  </body>
</html>