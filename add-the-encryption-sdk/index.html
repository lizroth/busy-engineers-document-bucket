



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="An introduction to using AWS KMS and the AWS Encryption SDK">
      
      
        <link rel="canonical" href="https://awssecworkshops.com/add-the-encryption-sdk/">
      
      
        <meta name="author" content="aws-cryptools@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.0">
    
    
      
        <title>Exercise 1: Add the AWS Encryption SDK - Busy Engineer's Document Bucket Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#exercise-1-add-the-aws-encryption-sdk" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Busy Engineer's Document Bucket Workshop
                </span>
                <span class="md-header-nav__topic">
                  Exercise 1: Add the AWS Encryption SDK
                </span>
              
            
          </div>
        </div>
  
        <!-- Button to open search dialogue -->
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              <!-- Search interface -->
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>
        
        <!-- Repository containing source -->
        
        <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__lang">
                <div class="md-lang-drop">
                    <button onclick="window.location.href = 'https://awssecworkshops.jp/';" class="md-lang-dropbtn fa fa-globe"></button>
                </div>
            </div>
        </div>

        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://awssecworkshops.com" title="Busy Engineer's Document Bucket Workshop" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Busy Engineer's Document Bucket Workshop
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Exercise 1: Add the AWS Encryption SDK
      </label>
    
    <a href="./" title="Exercise 1: Add the AWS Encryption SDK" class="md-nav__link md-nav__link--active">
      Exercise 1: Add the AWS Encryption SDK
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-add-the-esdk-dependency" class="md-nav__link">
    Step 1: Add the ESDK Dependency
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-encryption-to-store" class="md-nav__link">
    Step 2: Add Encryption to store
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-add-decryption-to-retrieve" class="md-nav__link">
    Step 3: Add Decryption to retrieve
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-plumb-in-your-config" class="md-nav__link">
    Step 4: Plumb In Your Config
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-add-the-esdk-dependency" class="md-nav__link">
    Step 1: Add the ESDK Dependency
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-encryption-to-store" class="md-nav__link">
    Step 2: Add Encryption to store
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-add-decryption-to-retrieve" class="md-nav__link">
    Step 3: Add Decryption to retrieve
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-plumb-in-your-config" class="md-nav__link">
    Step 4: Plumb In Your Config
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/busy-engineers-document-bucket/edit/master/docs/add-the-encryption-sdk.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="exercise-1-add-the-aws-encryption-sdk">Exercise 1: Add the AWS Encryption SDK</h1>
<h2 id="background">Background</h2>
<p>The Busy Engineer's Document Bucket is an example application meant to show some high-level examples of real world AWS patterns. This includes how to integrate client-side encryption using AWS KMS and the AWS Encryption SDK in application code.</p>
<p>Right now, the Document Bucket supports storing files (or documents, or other blobs of data) in a private S3 bucket, and indexing them in DynamoDB. This allows Document Bucket users to share files with other users, or store them for retrieval later. The DynamoDB entries provide fast lookups to the content of the bucket, along with metadata context for each bucket item.</p>
<p>This context allows storing additional information about the S3 item. Perhaps the origin user, the destination fleet, the project, or any other tag that would be useful to know without downloading and examining the item.</p>
<p>DynamoDB is also configured to allow indexing on which documents have which keys. So, for example, it's a quick query to find out which documents in the bucket have been tagged with "configuration" as a piece of metadata about the object contents.</p>
<p>Here's the API the Document Bucket supports:</p>
<ul>
<li><code>list</code>: This operation queries DynamoDB for all entries for all items in the bucket, and their metadata. It returns the <code>set</code> of items that have been stored.</li>
<li><code>store</code>: This operation accepts a blob of bytes and a <code>map</code> of metadata context. It generates a unique identifier for the document. The identifier and associated metadata are written to DynamoDB. The bytes of the data are written to S3 under a key of that unique identifier. Any context metadata keys in DynamoDB are updated to include that new object identifier.</li>
<li><code>retrieve</code>: This operation accepts a unique identifier as an argument. First it looks that identifier up in DynamoDB and pulls the identifier and its context out. Then it retrieves that object from S3. It bundles these items together and returns them to the caller.</li>
<li><code>search</code>: This operation accepts a metadata key to search for. It then queries DynamoDB for the <code>set</code> of documents in the Document Bucket that have context matching that key. This operation then returns that set of document identifiers and their metadata.<ul>
<li>Once the desired document or documents have been identified with the returned metadata, the document identifiers can be passed to <code>retrieve</code> to actually fetch the documents.</li>
</ul>
</li>
</ul>
<p>This is a start for sharing, storing, and searching documents of a variety of types. But what about sensitive documents? Or protecting, say, important configuration files from accidental corruption during storing or retrieving?</p>
<p>Now you will add the AWS Encryption SDK to encrypt close to where the data originates: client-side encrypting the Document Bucket document before it is transmitted off of the host machine to the internet. You will use KMS to provide a <code>data key</code> for each document, using a CMK that you set up in <a href="../getting-started/">Getting Started</a> when you deployed your stacks.</p>
<h2 id="make-the-change">Make the Change</h2>
<h3 id="starting-directory">Starting Directory</h3>
<p>Make sure you are in the <code>exercises</code> directory for the language of your choice:</p>
<p> <pre><code class=Java>~/environment/workshop/exercises/java
</code></pre></p>
<p>```Javascript Node.js
~/environment/workshop/exercises/node-javascript</p>
<p> <pre><code class>
```Python
~/environment/workshop/exercises/python
</code></pre></p>
<p><code>cd</code> into the <code>add-esdk-start</code> directory.</p>
<h3 id="step-1-add-the-esdk-dependency">Step 1: Add the ESDK Dependency</h3>
<p>Look for <code>ADD-ESDK-START</code> comments to help orient yourself in the code.</p>
<p>Start by adding the Encryption SDK dependency to the code.</p>
<p>```Javascript Node.js
// Edit ./store.js</p>
<p>const { encryptStream, KmsKeyringNode } = require("@aws-crypto/client-node");</p>
<p>// Save and exit</p>
<p>// Edit ./retrieve.js</p>
<p>const { decryptStream, KmsKeyringNode } = require("@aws-crypto/client-node");</p>
<p>// Save and exit</p>
<p> <pre><code class>
```Python
# Edit src/document_bucket/__init__.py

import aws_encryption_sdk

# Save and exit
# Edit src/document_bucket/api.py

# ADD-ESDK-START
import aws_encryption_sdk
from aws_encryption_sdk import KMSMasterKeyProvider

# Add a Master Key Provider to your __init__
# ADD-ESDK-START
def __init__(self, bucket, table, master_key_provider: KMSMasterKeyProvider):
    self.bucket = bucket
    self.table = table
    # ADD-ESDK-START
    self.master_key_provider = master_key_provider

# Save and exit
</code></pre></p>
<h4 id="what-just-happened">What Just Happened</h4>
<p>You just imported a dependency on the AWS Encryption SDK library in your code.</p>
<p>You also changed the API to expect that a Keyring or Master Key Provider will be passed to your code to use in <code>store</code> and <code>retrieve</code> operations.</p>
<h3 id="step-2-add-encryption-to-store">Step 2: Add Encryption to <code>store</code></h3>
<p>Now that you have the AWS Encryption SDK imported, start encrypting your data before storing it.</p>
<p>```Javascript Node.js
// Edit ./store.js</p>
<p>const Body = fileStream.pipe(encryptStream(encryptKeyring));</p>
<p>// Save and exit</p>
<p> <pre><code class>
```Python
# Edit src/document_bucket/api.py

def store(self, data: bytes, context: Dict[str, str] = {}) -&gt; PointerItem:
    # ADD-ESDK-START
    encrypted_data, header = aws_encryption_sdk.encrypt(
        source=data,
        key_provider=self.master_key_provider,
    )

# Save and exit
</code></pre></p>
<h4 id="what-just-happened_1">What Just Happened</h4>
<p>The application just started encrypting data client-side with the AWS Encryption SDK and KMS!</p>
<p>Now, before storing data in the Document Bucket, it uses the AWS Encryption SDK to:</p>
<ol>
<li>Request a new data key using your keyring or Master Key Provider</li>
<li>Encrypt that data for you</li>
<li>Return the encrypted data in the AWS Encryption SDK message format</li>
<li>Extract the ciphertext to pass to the AWS S3 SDK to store in S3</li>
</ol>
<h3 id="step-3-add-decryption-to-retrieve">Step 3: Add Decryption to <code>retrieve</code></h3>
<p>Now that you are encrypting data before storing it, you need to decrypt it before returning it to your caller. At least for it to be useful, anyway.</p>
<p>```Javascript Node.js
// Edit retrieve.js</p>
<p>return s3
    .getObject({ Bucket, Key })
    .createReadStream()
    .pipe(decryptStream(decryptKeyring));</p>
<p>// Save and Exit</p>
<p> <pre><code class>
#### What Just Happened
```Python
# Edit src/document_bucket/api.py

    def retrieve(
            self,
            pointer_key: str,
            expected_context_keys: Set[str] = set(),
            expected_context: Dict[str, str] = {},
    ) -&gt; DocumentBundle:
        item = self._get_pointer_item(PointerQuery.from_key(pointer_key))
        # ADD-ESDK-START
        encrypted_data = self._get_object(item)
        plaintext, header = aws_encryption_sdk.decrypt(
            source=encrypted_data, key_provider=self.master_key_provider
        )
        return DocumentBundle.from_data_and_context(
            plaintext, item.context
        )

# Save and exit
</code></pre></p>
<p>The application just started decrypting data client-side as well!</p>
<p>The data returned from S3 for <code>retrieve</code> is now encrypted. Before returning that data to the user, you added a call to the AWS Encryption SDK to decrypt the data. Under the hood, the Encryption SDK:</p>
<ol>
<li>Read the AWS Encryption SDK formatted encrypted message</li>
<li>Called KMS to request to decrypt your message's encrypted data key using the Faythe CMK</li>
<li>Used the decrypted data key to decrypt the message</li>
<li>Returned the message plaintext and Encryption SDK headers to you</li>
</ol>
<h3 id="step-4-plumb-in-your-config">Step 4: Plumb In Your Config</h3>
<p>Now that you have your dependencies declared and your code updated to encrypt and decrypt data, the final step is to pass through the configuration to the AWS Encryption SDK to start using your KMS CMKs to protect your data.</p>
<p>```Javascript Node.js</p>
<p>// Edit store.js</p>
<p>const faytheCMK = config.state.getFaytheCMK();
const encryptKeyring = new KmsKeyringNode({
  generatorKeyId: faytheCMK
});</p>
<p>// Save and exit</p>
<p>// Edit retrieve.js</p>
<p>const faytheCMK = config.state.getFaytheCMK();
const decryptKeyring = new KmsKeyringNode({ keyIds: [faytheCMK] });</p>
<p>// Save and exit</p>
<p> <pre><code class>
```Python

# Edit src/document_bucket/__init__.py

...

# ADD-ESDK-START
# Pull configuration of KMS resources
faythe_cmk = state[&quot;FaytheCMK&quot;]
# And the Master Key Provider configuring how to use KMS
cmk = [faythe_cmk]
mkp = aws_encryption_sdk.KMSMasterKeyProvider(key_ids=[cmk])

...

operations = DocumentBucketOperations(bucket, table, mkp)

# Save and exit
</code></pre></p>
<h4 id="what-just-happened_2">What Just Happened</h4>
<p>In Getting Started, you launched CloudFormation stacks for CMKs. One of these CMKs was nicknamed Faythe. As part of launching these templates, the CMK's Amazon Resource Name (ARN) was written to a configuration file on disk, the <code>state</code> variable that is loaded and parsed.</p>
<p>Now Faythe's ARN is pulled into a variable, and used to initialize a keyring or master key provider that will use the Faythe CMK. That new keyring/master key provider is passed in to your API, and you are set to start encrypting and decrypting with KMS and the Encryption SDK.</p>
<h3 id="checking-your-work">Checking Your Work</h3>
<p>Want to check your progress, or compare what you've done versus a finished example?</p>
<p>Check out the code in one of the <code>-complete</code> folders to compare.</p>
<p> <pre><code class=Java>~/environment/workshop/exercises/java/add-esdk-complete
</code></pre></p>
<p>```Javascript Node.js
~/environment/workshop/exercises/node-javascript/add-esdk-complete/store.js
~/environment/workshop/exercises/node-javascript/add-esdk-complete/retrieve.js</p>
<p> <pre><code class>
```Python
~/environment/workshop/exercises/python/add-esdk-complete
</code></pre></p>
<h2 id="try-it-out">Try it Out</h2>
<p>Now that the code is written, let's load it up and try it out.</p>
<p>If you'd like to try a finished example, use your language's <code>-complete</code> directory as described above.</p>
<p>```Javascript Node.js REPL
node
list = require("./list.js")
store = require("./store.js")
list().then(console.log)
store(fs.createReadStream("./store.js")).then(console.log)
list().then(console.log)</p>
<div class=md-fenced-code-tabs id=tab-tab-group-8><input name=tab-group-8 type=radio id=tab-group-8-0_gn6vudbzj7hdb08 checked=checked class=code-tab data-lang aria-controls=tab-group-8-0_gn6vudbzj7hdb08-panel role=tab><label for=tab-group-8-0_gn6vudbzj7hdb08 class=code-tab-label data-lang id=tab-group-8-0_gn6vudbzj7hdb08-label></label><div class=code-tabpanel role=tabpanel data-lang id=tab-group-8-0_gn6vudbzj7hdb08-panel aria-labelledby=tab-group-8-0_gn6vudbzj7hdb08-label><pre><code class>
```Javascript Node.js CLI
./cli.js list
./cli.js store ./store.js
./cli.js list
</code></pre></div><input name=tab-group-8 type=radio id=tab-group-8-1_Python class=code-tab data-lang=Python aria-controls=tab-group-8-1_Python-panel role=tab><label for=tab-group-8-1_Python class=code-tab-label data-lang=Python id=tab-group-8-1_Python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=Python id=tab-group-8-1_Python-panel aria-labelledby=tab-group-8-1_Python-label><pre><code class=Python>tox -e repl
import document_bucket
ops = document_bucket.initialize()
ops.list()
ops.store(b'some data')
ops.list()
# Ctrl-D when finished to exit the REPL
</code></pre></div></div>

<h2 id="explore-further">Explore Further</h2>
<ul>
<li>TODO Retrieve</li>
<li>TODO Examine TOML files</li>
<li>TODO Generate and load files to store/retrieve</li>
</ul>
<h1 id="next-exercise">Next exercise</h1>
<p>Now that you are encrypting and decrypting, how about <a href="./multi-cmk.md">adding Multiple CMKs</a>?</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="../getting-started/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Getting Started
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a8b5e56f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../javascripts/extra.js"></script>
      
    
  </body>
</html>