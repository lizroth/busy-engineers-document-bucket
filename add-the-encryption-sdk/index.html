



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="An introduction to using AWS KMS and the AWS Encryption SDK">
      
      
        <link rel="canonical" href="https://awssecworkshops.com/add-the-encryption-sdk/">
      
      
        <meta name="author" content="aws-cryptools@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.0">
    
    
      
        <title>Add the Encryption SDK - Busy Engineer's Document Bucket Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#exercise-1-add-the-aws-encryption-sdk" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Busy Engineer's Document Bucket Workshop
                </span>
                <span class="md-header-nav__topic">
                  Add the Encryption SDK
                </span>
              
            
          </div>
        </div>
  
        <!-- Button to open search dialogue -->
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              <!-- Search interface -->
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>
        
        <!-- Repository containing source -->
        
        <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__lang">
                <div class="md-lang-drop">
                    <button onclick="window.location.href = 'https://awssecworkshops.com';" class="md-lang-dropbtn fa fa-globe"></button>
                </div>
            </div>
        </div>

        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          Exercises
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://awssecworkshops.com" title="Busy Engineer's Document Bucket Workshop" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Busy Engineer's Document Bucket Workshop
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/busy-engineers-document-bucket/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/busy-engineers-document-bucket
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Exercises
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Add the Encryption SDK
      </label>
    
    <a href="./" title="Add the Encryption SDK" class="md-nav__link md-nav__link--active">
      Add the Encryption SDK
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-add-the-esdk-dependency" class="md-nav__link">
    Step 1: Add the ESDK Dependency
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-encryption-to-store" class="md-nav__link">
    Step 2: Add Encryption to store
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-add-decryption-to-retrieve" class="md-nav__link">
    Step 3: Add Decryption to retrieve
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-configure-the-faythe-cmk-in-the-encryption-sdk" class="md-nav__link">
    Step 4: Configure the Faythe CMK in the Encryption SDK
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_3" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multi-cmk/" title="Using Multiple CMKs" class="md-nav__link">
      Using Multiple CMKs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../encryption-context/" title="Working With Encryption Context" class="md-nav__link">
      Working With Encryption Context
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../thank-you-and-closing/" title="Thank You and Closing" class="md-nav__link">
      Thank You and Closing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-change" class="md-nav__link">
    Make the Change
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-directory" class="md-nav__link">
    Starting Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-add-the-esdk-dependency" class="md-nav__link">
    Step 1: Add the ESDK Dependency
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-encryption-to-store" class="md-nav__link">
    Step 2: Add Encryption to store
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_1" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-add-decryption-to-retrieve" class="md-nav__link">
    Step 3: Add Decryption to retrieve
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_2" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-configure-the-faythe-cmk-in-the-encryption-sdk" class="md-nav__link">
    Step 4: Configure the Faythe CMK in the Encryption SDK
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-just-happened_3" class="md-nav__link">
    What Just Happened
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-your-work" class="md-nav__link">
    Checking Your Work
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-out" class="md-nav__link">
    Try it Out
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explore-further" class="md-nav__link">
    Explore Further
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/busy-engineers-document-bucket/edit/master/docs/add-the-encryption-sdk.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="exercise-1-add-the-aws-encryption-sdk">Exercise 1: Add the AWS Encryption SDK</h1>
<p>In this section, you will add client-side encryption using the AWS Encryption SDK and KMS to the Busy Engineer's Document Bucket.</p>
<h2 id="background">Background</h2>
<p>The Busy Engineer's Document Bucket is an example application meant to show some high-level examples of real world AWS patterns. This includes how to integrate client-side encryption using AWS KMS and the AWS Encryption SDK in application code.</p>
<p>Right now, the Document Bucket supports storing files (or documents, or other blobs of data) in a private S3 bucket, and indexing them in DynamoDB. This allows Document Bucket users to share files with other users, or store them for retrieval later. The DynamoDB entries provide fast lookups to the content of the bucket, along with metadata context for each bucket item.</p>
<p>This context allows storing additional information about the S3 item. Perhaps the origin user, the destination fleet, the project, or any other tag that would be useful to know without downloading and examining the item.</p>
<p>DynamoDB is also configured to allow indexing on which documents have which keys. So, for example, it's a quick query to find out which documents in the bucket have been tagged with "configuration" as a piece of metadata about the object contents.</p>
<p>Here's the API the Document Bucket supports:</p>
<ul>
<li><code>list</code>: This operation queries DynamoDB for all entries for all items in the bucket, and their metadata. It returns the <code>set</code> of items that have been stored.</li>
<li><code>store</code>: This operation accepts a blob of bytes and a <code>map</code> of metadata context. It generates a unique identifier for the document. The identifier and associated metadata are written to DynamoDB. The bytes of the data are written to S3 under a key of that unique identifier. Any context metadata keys in DynamoDB are updated to include that new object identifier.</li>
<li><code>retrieve</code>: This operation accepts a unique identifier as an argument. First it looks that identifier up in DynamoDB and pulls the identifier and its context out. Then it retrieves that object from S3. It bundles these items together and returns them to the caller.</li>
<li><code>search</code>: This operation accepts a metadata key to search for. It then queries DynamoDB for the <code>set</code> of documents in the Document Bucket that have context matching that key. This operation then returns that set of document identifiers and their metadata.<ul>
<li>Once the desired document or documents have been identified with the returned metadata, the document identifiers can be passed to <code>retrieve</code> to actually fetch the documents.</li>
</ul>
</li>
</ul>
<p>This is a start for sharing, storing, and searching documents of a variety of types. But what about sensitive documents? Or protecting, say, important configuration files from accidental corruption during storing or retrieving?</p>
<p>Now you will add the AWS Encryption SDK to encrypt close to where the data originates: client-side encrypting the Document Bucket document before it is transmitted off of the host machine to the internet. You will use KMS to provide a <code>data key</code> for each document, using a CMK that you set up in <a href="../getting-started/">Getting Started</a> when you deployed your stacks.</p>
<h2 id="make-the-change">Make the Change</h2>
<h3 id="starting-directory">Starting Directory</h3>
<p>Make sure you are in the <code>exercises</code> directory for the language of your choice:</p>
<div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked" />
<label for="__tab_1_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/java
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_1" />
<label for="__tab_1_1">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/node-typescript
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_2" />
<label for="__tab_1_2">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/node-javascript
</pre></div>
</td></tr></table></div>
<input name="__tabs_1" type="radio" id="__tab_1_3" />
<label for="__tab_1_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/environment/workshop/exercises/python
</pre></div>
</td></tr></table></div>
</div>
<p><code>cd</code> into the <code>add-esdk-start</code> directory.</p>
<h3 id="step-1-add-the-esdk-dependency">Step 1: Add the ESDK Dependency</h3>
<p>Look for <code>ADD-ESDK-START</code> comments to help orient yourself in the code.</p>
<p>Start by adding the Encryption SDK dependency to the code.</p>
<div class="superfences-tabs">
<input name="__tabs_2" type="radio" id="__tab_2_0" checked="checked" />
<label for="__tab_2_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit Api.java</span>
<span class="kn">package</span> <span class="nn">sfw.example.esdkworkshop</span><span class="o">;</span>

<span class="c1">// ADD-ESDK-START: Add the ESDK Dependency</span>
<span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.AwsCrypto</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.CryptoResult</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.MasterKey</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.MasterKeyProvider</span><span class="o">;</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.kms.KmsMasterKey</span><span class="o">;</span>
</span>
<span class="o">...</span>

<span class="c1">// ADD-ESDK-START: Add the ESDK Dependency</span>
<span class="hll"><span class="kd">private</span> <span class="kd">final</span> <span class="n">AwsCrypto</span> <span class="n">awsEncryptionSdk</span><span class="o">;</span>
</span><span class="hll"><span class="kd">private</span> <span class="kd">final</span> <span class="n">MasterKeyProvider</span> <span class="n">mkp</span><span class="o">;</span>
</span>
<span class="o">...</span>

<span class="kd">public</span> <span class="nf">Api</span><span class="o">(</span>
    <span class="n">AmazonDynamoDB</span> <span class="n">ddbClient</span><span class="o">,</span>
    <span class="n">String</span> <span class="n">tableName</span><span class="o">,</span>
    <span class="n">AmazonS3</span> <span class="n">s3Client</span><span class="o">,</span>
    <span class="n">String</span> <span class="n">bucketName</span><span class="o">,</span>
    <span class="c1">// ADD-ESDK-START: Add the ESDK Dependency</span>
<span class="hll">    <span class="n">MasterKeyProvider</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">MasterKey</span><span class="o">&gt;</span> <span class="n">mkp</span><span class="o">)</span> <span class="o">{</span>
</span>  <span class="k">this</span><span class="o">.</span><span class="na">ddbClient</span> <span class="o">=</span> <span class="n">ddbClient</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">tableName</span> <span class="o">=</span> <span class="n">tableName</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">s3Client</span> <span class="o">=</span> <span class="n">s3Client</span>
  <span class="c1">// ADD-ESDK-START: Add the ESDK Dependency</span>
<span class="hll">  <span class="k">this</span><span class="o">.</span><span class="na">awsEncryptionSdk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AwsCrypto</span><span class="o">();</span>
</span><span class="hll">  <span class="k">this</span><span class="o">.</span><span class="na">mkp</span> <span class="o">=</span> <span class="n">mkp</span><span class="o">;</span>
</span><span class="o">}</span>

<span class="c1">// Save and close.</span>
<span class="c1">// Edit App.java</span>
<span class="hll"><span class="kn">package</span> <span class="nn">sfw.example.esdkworkshop</span><span class="o">;</span>
</span>
<span class="c1">// ADD-ESDK-START: Add the ESDK Dependency</span>
<span class="hll"><span class="kn">import</span> <span class="nn">com.amazonaws.encryptionsdk.kms.KmsMasterKeyProvider</span><span class="o">;</span>
</span><span class="c1">// Save and close.</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_2" type="radio" id="__tab_2_1" />
<label for="__tab_2_1">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit ./store.js</span>

<span class="c1">// ADD-ESDK-START: Add the @aws-crypto/client-node dependency</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">encryptStream</span><span class="p">,</span> <span class="nx">KmsKeyringNode</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@aws-crypto/client-node&quot;</span><span class="p">;</span>
</span>
<span class="c1">// Save and exit</span>

<span class="c1">// Edit ./retrieve.js</span>

<span class="c1">// ADD-ESDK-START: Add the @aws-crypto/client-node dependency</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">decryptStream</span><span class="p">,</span> <span class="nx">KmsKeyringNode</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@aws-crypto/client-node&quot;</span><span class="p">;</span>
</span>
<span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_2" type="radio" id="__tab_2_2" />
<label for="__tab_2_2">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit ./store.js</span>

<span class="c1">// ADD-ESDK-START: Add the @aws-crypto/client-node dependency</span>
<span class="hll"><span class="kr">const</span> <span class="p">{</span> <span class="nx">encryptStream</span><span class="p">,</span> <span class="nx">KmsKeyringNode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;@aws-crypto/client-node&quot;</span><span class="p">);</span>
</span>
<span class="c1">// Save and exit</span>

<span class="c1">// Edit ./retrieve.js</span>

<span class="c1">// ADD-ESDK-START: Add the @aws-crypto/client-node dependency</span>
<span class="hll"><span class="kr">const</span> <span class="p">{</span> <span class="nx">decryptStream</span><span class="p">,</span> <span class="nx">KmsKeyringNode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;@aws-crypto/client-node&quot;</span><span class="p">);</span>
</span>
<span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_2" type="radio" id="__tab_2_3" />
<label for="__tab_2_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/__init__.py</span>

<span class="kn">import</span> <span class="nn">aws_encryption_sdk</span>

<span class="c1"># Save and exit</span>
<span class="c1"># Edit src/document_bucket/api.py</span>

<span class="c1"># ADD-ESDK-START</span>
<span class="kn">import</span> <span class="nn">aws_encryption_sdk</span>
<span class="kn">from</span> <span class="nn">aws_encryption_sdk</span> <span class="kn">import</span> <span class="n">KMSMasterKeyProvider</span>

<span class="c1"># Add a Master Key Provider to your __init__</span>
<span class="c1"># ADD-ESDK-START</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">master_key_provider</span><span class="p">:</span> <span class="n">KMSMasterKeyProvider</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
    <span class="c1"># ADD-ESDK-START</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">master_key_provider</span> <span class="o">=</span> <span class="n">master_key_provider</span>

<span class="c1"># Save and exit</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened">What Just Happened</h4>
<p>You just imported a dependency on the AWS Encryption SDK library in your code.</p>
<p>You also changed the API to expect that a Keyring or Master Key Provider will be passed to your code to use in <code>store</code> and <code>retrieve</code> operations.</p>
<h3 id="step-2-add-encryption-to-store">Step 2: Add Encryption to <code>store</code></h3>
<p>Now that you have the AWS Encryption SDK imported, start encrypting your data before storing it.</p>
<div class="superfences-tabs">
<input name="__tabs_3" type="radio" id="__tab_3_0" checked="checked" />
<label for="__tab_3_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit Api.java</span>
<span class="kd">public</span> <span class="n">PointerItem</span> <span class="nf">store</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">    <span class="n">CryptoResult</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="n">KmsMasterKey</span><span class="o">&gt;</span> <span class="n">encryptedMessage</span> <span class="o">=</span> <span class="n">awsEncryptionSdk</span><span class="o">.</span><span class="na">encryptData</span><span class="o">(</span><span class="n">mkp</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class="hll">    <span class="n">DocumentBundle</span> <span class="n">bundle</span> <span class="o">=</span>
</span><span class="hll">        <span class="n">DocumentBundle</span><span class="o">.</span><span class="na">fromDataAndContext</span><span class="o">(</span><span class="n">encryptedMessage</span><span class="o">.</span><span class="na">getResult</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
</span>    <span class="n">writeItem</span><span class="o">(</span><span class="n">bundle</span><span class="o">.</span><span class="na">getPointer</span><span class="o">());</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_3" type="radio" id="__tab_3_1" />
<label for="__tab_3_1">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit ./store.js</span>

<span class="c1">// ADD-ESDK-START: Encrypt the stream with a keyring</span>
<span class="hll"><span class="kr">const</span> <span class="nx">Body</span> <span class="o">=</span> <span class="nx">fileStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">encryptStream</span><span class="p">(</span><span class="nx">encryptKeyring</span><span class="p">));</span>
</span>
<span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_3" type="radio" id="__tab_3_2" />
<label for="__tab_3_2">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit ./store.js</span>

<span class="c1">// ADD-ESDK-START: Encrypt the stream with a keyring</span>
<span class="hll"><span class="kr">const</span> <span class="nx">Body</span> <span class="o">=</span> <span class="nx">fileStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">encryptStream</span><span class="p">(</span><span class="nx">encryptKeyring</span><span class="p">));</span>
</span>
<span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_3" type="radio" id="__tab_3_3" />
<label for="__tab_3_3">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/api.py</span>
<span class="c1"># Find the store function and edit it to add the Master Key Provider</span>
<span class="c1"># and to write the encrypted data</span>
    <span class="c1"># ADD-ESDK-START</span>
    <span class="n">encrypted_data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">aws_encryption_sdk</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">key_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">master_key_provider</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_write_object</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened_1">What Just Happened</h4>
<p>The application will now encrypt data client-side with the AWS Encryption SDK and KMS before storing it.</p>
<p>Now, before storing data in the Document Bucket, it uses the AWS Encryption SDK to:</p>
<ol>
<li>Request a new data key using your keyring or Master Key Provider</li>
<li>Encrypt that data for you</li>
<li>Return the encrypted data in the AWS Encryption SDK message format</li>
<li>Extract the ciphertext to pass to the AWS S3 SDK to store in S3</li>
</ol>
<h3 id="step-3-add-decryption-to-retrieve">Step 3: Add Decryption to <code>retrieve</code></h3>
<p>Now that the application will encrypt data before storing it, it will need to decrypt the data before returning it to the caller. At least for the data to be useful, anyway.</p>
<div class="superfences-tabs">
<input name="__tabs_4" type="radio" id="__tab_4_0" checked="checked" />
<label for="__tab_4_0">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit retrieve.js</span>

  <span class="c1">// ADD-ESDK-START: Decrypt the stream with a keyring</span>
  <span class="k">return</span> <span class="nx">s3</span>
    <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
<span class="hll">    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">));</span>
</span>
<span class="c1">// Save and Exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_1" />
<label for="__tab_4_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit retrieve.js</span>

  <span class="c1">// ADD-ESDK-START: Decrypt the stream with a keyring</span>
  <span class="k">return</span> <span class="nx">s3</span>
    <span class="p">.</span><span class="nx">getObject</span><span class="p">({</span> <span class="nx">Bucket</span><span class="p">,</span> <span class="nx">Key</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">createReadStream</span><span class="p">()</span>
<span class="hll">    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decryptStream</span><span class="p">(</span><span class="nx">decryptKeyring</span><span class="p">));</span>
</span>
<span class="c1">// Save and Exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_4" type="radio" id="__tab_4_2" />
<label for="__tab_4_2">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/api.py</span>
<span class="c1"># Find the retrieve function and edit it to add a call to decrypt the</span>
<span class="c1"># encrypted data before returning it</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pointer_item</span><span class="p">(</span><span class="n">PointerQuery</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">pointer_key</span><span class="p">))</span>
        <span class="c1"># ADD-ESDK-START</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">plaintext</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">aws_encryption_sdk</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">encrypted_data</span><span class="p">,</span> <span class="n">key_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">master_key_provider</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">DocumentBundle</span><span class="o">.</span><span class="n">from_data_and_context</span><span class="p">(</span>
            <span class="n">plaintext</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">context</span>
        <span class="p">)</span>

<span class="c1"># Save and exit</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened_2">What Just Happened</h4>
<p>The application now decrypts data client-side as well.</p>
<p>The data returned from S3 for <code>retrieve</code> is now encrypted. Before returning that data to the user, you added a call to the AWS Encryption SDK to decrypt the data. Under the hood, the Encryption SDK:</p>
<ol>
<li>Read the AWS Encryption SDK formatted encrypted message</li>
<li>Called KMS to request to decrypt your message's encrypted data key using the Faythe CMK</li>
<li>Used the decrypted data key to decrypt the message</li>
<li>Returned the message plaintext and Encryption SDK headers to you</li>
</ol>
<h3 id="step-4-configure-the-faythe-cmk-in-the-encryption-sdk">Step 4: Configure the Faythe CMK in the Encryption SDK</h3>
<p>Now that you have your dependencies declared and your code updated to encrypt and decrypt data, the final step is to pass through the configuration to the AWS Encryption SDK to start using your KMS CMKs to protect your data.</p>
<div class="superfences-tabs">
<input name="__tabs_5" type="radio" id="__tab_5_0" checked="checked" />
<label for="__tab_5_0">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit store.js</span>

<span class="c1">// ADD-ESDK-START: Set up a keyring to use Faythe&#39;s CMK for decrypting.</span>
<span class="kr">const</span> <span class="nx">faytheCMK</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">getFaytheCMK</span><span class="p">();</span>
<span class="hll"><span class="kr">const</span> <span class="nx">encryptKeyring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KmsKeyringNode</span><span class="p">({</span>
</span><span class="hll">  <span class="nx">generatorKeyId</span>: <span class="kt">faytheCMK</span>
</span><span class="hll"><span class="p">});</span>
</span><span class="hll">
</span><span class="c1">// Save and exit</span>

<span class="c1">// Edit retrieve.js</span>

<span class="c1">// ADD-ESDK-START: Set up a keyring to use Faythe&#39;s CMK for decrypting.</span>
<span class="kr">const</span> <span class="nx">faytheCMK</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">getFaytheCMK</span><span class="p">();</span>
<span class="hll"><span class="kr">const</span> <span class="nx">decryptKeyring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KmsKeyringNode</span><span class="p">({</span> <span class="nx">keyIds</span><span class="o">:</span> <span class="p">[</span><span class="nx">faytheCMK</span><span class="p">]</span> <span class="p">});</span>
</span><span class="hll">
</span><span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_1" />
<label for="__tab_5_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Edit store.js</span>

<span class="c1">// ADD-ESDK-START: Set up a keyring to use Faythe&#39;s CMK for decrypting.</span>
<span class="kr">const</span> <span class="nx">faytheCMK</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">getFaytheCMK</span><span class="p">();</span>
<span class="hll"><span class="kr">const</span> <span class="nx">encryptKeyring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KmsKeyringNode</span><span class="p">({</span>
</span><span class="hll">  <span class="nx">generatorKeyId</span><span class="o">:</span> <span class="nx">faytheCMK</span>
</span><span class="hll"><span class="p">});</span>
</span><span class="hll">
</span><span class="c1">// Save and exit</span>

<span class="c1">// Edit retrieve.js</span>

<span class="c1">// ADD-ESDK-START: Set up a keyring to use Faythe&#39;s CMK for decrypting.</span>
<span class="kr">const</span> <span class="nx">faytheCMK</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">getFaytheCMK</span><span class="p">();</span>
<span class="hll"><span class="kr">const</span> <span class="nx">decryptKeyring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KmsKeyringNode</span><span class="p">({</span> <span class="nx">keyIds</span><span class="o">:</span> <span class="p">[</span><span class="nx">faytheCMK</span><span class="p">]</span> <span class="p">});</span>
</span><span class="hll">
</span><span class="c1">// Save and exit</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_5" type="radio" id="__tab_5_2" />
<label for="__tab_5_2">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Edit src/document_bucket/__init__.py</span>

<span class="o">...</span>

<span class="c1"># ADD-ESDK-START</span>
<span class="c1"># Pull configuration of KMS resources</span>
<span class="n">faythe_cmk</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;FaytheCMK&quot;</span><span class="p">]</span>
<span class="c1"># And the Master Key Provider configuring how to use KMS</span>
<span class="n">cmk</span> <span class="o">=</span> <span class="p">[</span><span class="n">faythe_cmk</span><span class="p">]</span>
<span class="n">mkp</span> <span class="o">=</span> <span class="n">aws_encryption_sdk</span><span class="o">.</span><span class="n">KMSMasterKeyProvider</span><span class="p">(</span><span class="n">key_ids</span><span class="o">=</span><span class="n">cmk</span><span class="p">)</span>

<span class="n">operations</span> <span class="o">=</span> <span class="n">DocumentBucketOperations</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mkp</span><span class="p">)</span>

<span class="c1"># Save and exit</span>
</pre></div>
</td></tr></table></div>
</div>
<h4 id="what-just-happened_3">What Just Happened</h4>
<p>In Getting Started, you launched CloudFormation stacks for CMKs. One of these CMKs was nicknamed Faythe. As part of launching these templates, the CMK's Amazon Resource Name (ARN) was written to a configuration file on disk, the <code>state</code> variable that is loaded and parsed.</p>
<p>Now Faythe's ARN is pulled into a variable, and used to initialize a keyring or master key provider that will use the Faythe CMK. That new keyring/master key provider is passed in to your API, and you are set to start encrypting and decrypting with KMS and the Encryption SDK.</p>
<h3 id="checking-your-work">Checking Your Work</h3>
<p>Want to check your progress, or compare what you've done versus a finished example?</p>
<p>Check out the code in one of the <code>-complete</code> folders to compare.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">~/</span><span class="n">environment</span><span class="o">/</span><span class="n">workshop</span><span class="o">/</span><span class="n">exercises</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">add</span><span class="o">-</span><span class="n">esdk</span><span class="o">-</span><span class="n">complete</span>
</pre></div>
</td></tr></table>

<div class="superfences-tabs">
<input name="__tabs_6" type="radio" id="__tab_6_0" checked="checked" />
<label for="__tab_6_0">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">~</span><span class="err">/environment/workshop/exercises/node-javascript/add-esdk-complete/store.js</span>
<span class="o">~</span><span class="err">/environment/workshop/exercises/node-javascript/add-esdk-complete/retrieve.js</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_6" type="radio" id="__tab_6_1" />
<label for="__tab_6_1">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">~/</span><span class="n">environment</span><span class="o">/</span><span class="n">workshop</span><span class="o">/</span><span class="n">exercises</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">add</span><span class="o">-</span><span class="n">esdk</span><span class="o">-</span><span class="n">complete</span>
</pre></div>
</td></tr></table></div>
</div>
<h2 id="try-it-out">Try it Out</h2>
<p>Now that the code is written, let's load it up and try it out.</p>
<p>If you'd like to try a finished example, use your language's <code>-complete</code> directory as described above.</p>
<p>Experiment using the API as much as you like. To get you started, here are some suggested things to try.</p>
<ul>
<li>Compare <a href="https://us-east-2.console.aws.amazon.com/cloudtrail/home?region=us-east-2#" target="_blank">CloudTrail Logs for usages of Faythe</a> when you encrypt messages of different sizes (small, medium, large).</li>
<li>Take a look at the <a href="https://s3.console.aws.amazon.com/s3/home" target="_blank">contents of your S3 Document Bucket</a> to inspect the raw object.</li>
</ul>
<p>If you want more ideas to extend, check out <a href="#explore-further">Explore Further</a> below.</p>
<div class="superfences-tabs">
<input name="__tabs_7" type="radio" id="__tab_7_0" checked="checked" />
<label for="__tab_7_0">Java</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// To use the API programmatically, use this target to launch jshell</span>
<span class="n">mvn</span> <span class="n">jshell</span><span class="o">:</span><span class="n">run</span>
<span class="o">/</span><span class="n">open</span> <span class="n">startup</span><span class="o">.</span><span class="na">jsh</span>
<span class="n">Api</span> <span class="n">documentBucket</span> <span class="o">=</span> <span class="n">App</span><span class="o">.</span><span class="na">initializeDocumentBucket</span><span class="o">();</span>
<span class="n">documentBucket</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
<span class="n">documentBucket</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="s">&quot;Store me in the Document Bucket!&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
<span class="k">for</span> <span class="o">(</span><span class="n">PointerItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">documentBucket</span><span class="o">.</span><span class="na">list</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">DocumentBundle</span> <span class="n">document</span> <span class="o">=</span> <span class="n">documentBucket</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">partitionKey</span><span class="o">());</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">document</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">// To run logic that you write in App.java, use this target</span>
<span class="n">mvn</span> <span class="n">compile</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_1" />
<label for="__tab_7_1">JavaScript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">node</span>
<span class="nx">list</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./list.js&quot;</span><span class="p">)</span>
<span class="nx">store</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./store.js&quot;</span><span class="p">)</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">store</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s2">&quot;./store.js&quot;</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Just storing the s3 key</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Key</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">retrieve</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span>
<span class="c1">// Ctrl-D when finished to exit the REPL</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_2" />
<label for="__tab_7_2">JavaScript Node.JS CLI</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./cli.js list
./cli.js store ./store.js
<span class="c1"># Note the &quot;Key&quot; value</span>
./cli.js list
<span class="c1"># Note the &quot;reference&quot; value</span>
./cli.js retrieve <span class="nv">$KeyOrReferenceValue</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_3" />
<label for="__tab_7_3">Typescript Node.JS</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">node</span> <span class="o">-</span><span class="nx">r</span> <span class="nx">ts</span><span class="o">-</span><span class="nx">node</span><span class="o">/</span><span class="nx">register</span>
<span class="p">;({</span><span class="nx">list</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./src/list.ts&quot;</span><span class="p">))</span>
<span class="p">;({</span><span class="nx">store</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./src/store.ts&quot;</span><span class="p">))</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">store</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s2">&quot;./src/store.ts&quot;</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Just storing the s3 key</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Key</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">list</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="nx">retrieve</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span>
<span class="c1">// Ctrl-D when finished to exit the REPL</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_4" />
<label for="__tab_7_4">Typescript Node.JS CLI</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./cli.ts list
./cli.ts store ./store.js
<span class="c1"># Note the &quot;Key&quot; value</span>
./cli.ts list
<span class="c1"># Note the &quot;reference&quot; value</span>
./cli.ts retrieve <span class="nv">$KeyOrReferenceValue</span>
</pre></div>
</td></tr></table></div>
<input name="__tabs_7" type="radio" id="__tab_7_5" />
<label for="__tab_7_5">Python</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">tox</span> <span class="o">-</span><span class="n">e</span> <span class="n">repl</span>
<span class="kn">import</span> <span class="nn">document_bucket</span>
<span class="n">ops</span> <span class="o">=</span> <span class="n">document_bucket</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">ops</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="n">ops</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;some data&#39;</span><span class="p">)</span>
<span class="n">ops</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="c1"># Ctrl-D when finished to exit the REPL</span>
</pre></div>
</td></tr></table></div>
</div>
<h2 id="explore-further">Explore Further</h2>
<ul>
<li><strong>Leveraging the Message Format</strong> - The <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/message-format.html" target="_blank">AWS Encryption SDK Message Format</a> is an open standard. Can you write something to detect whether an entry in the Document Bucket has been encrypted in this format or not, and retrieve or decrypt appropriately?</li>
<li><strong>More Test Content</strong> - Small test strings are enough to get started, but you might be curious to see what the behavior and performance looks like with larger documents. What if you add support for loading files to and from disk to the Document Bucket?</li>
<li><strong>Configuration Glue</strong> - If you are curious how the Document Bucket is configured, take a peek at <code>~/environment/workshop/cdk/Makefile</code> and the <code>make state</code> target, as well as <code>config.toml</code> in the exercises root <code>~/environment/workshop/exercises/config.toml</code>. The Busy Engineer's Document Bucket uses a base <a href="https://github.com/toml-lang/toml" target="_blank">TOML</a> file to set standard names for all CloudFormation resources and a common place to discover the real deployed set. Then it uses the AWS Cloud Development Kit (CDK) to deploy the resources and write out their identifiers to the state file. Applications use the base TOML file <code>config.toml</code> to locate the state file and pull the expected resource names. And that's how the system bootstraps all the resources it needs!</li>
</ul>
<h1 id="next-exercise">Next exercise</h1>
<p>Now that you are encrypting and decrypting, how about <a href="../multi-cmk/">adding Multiple CMKs</a>?</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../getting-started/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </span>
            </div>
          </a>
        
        
          <a href="../multi-cmk/" title="Using Multiple CMKs" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Using Multiple CMKs
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a8b5e56f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../javascripts/extra.js"></script>
      
    
  </body>
</html>