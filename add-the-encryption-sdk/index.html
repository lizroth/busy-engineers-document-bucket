<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Exercise 1: Add the AWS Encryption SDK - Busy Engineer's Document Bucket Workshop</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Busy Engineer's Document Bucket Workshop</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="active">
                                <a href="./">Exercise 1: Add the AWS Encryption SDK</a>
                            </li>
                            <li >
                                <a href="../getting-started/">Getting Started</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="disabled">
                                <a rel="next" >
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../getting-started/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#exercise-1-add-the-aws-encryption-sdk">Exercise 1: Add the AWS Encryption SDK</a></li>
            <li><a href="#background">Background</a></li>
            <li><a href="#make-the-change">Make the Change</a></li>
            <li><a href="#try-it-out">Try it Out</a></li>
            <li><a href="#explore-further">Explore Further</a></li>
        <li class="main "><a href="#next-exercise">Next exercise</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="exercise-1-add-the-aws-encryption-sdk">Exercise 1: Add the AWS Encryption SDK</h1>
<h2 id="background">Background</h2>
<p>The Busy Engineer's Document Bucket is an example application meant to show some high-level examples of real world AWS patterns. This includes how to integrate client-side encryption using AWS KMS and the AWS Encryption SDK in application code.</p>
<p>Right now, the Document Bucket supports storing files (or documents, or other blobs of data) in a private S3 bucket, and indexing them in DynamoDB. This allows Document Bucket users to share files with other users, or store them for retrieval later. The DynamoDB entries provide fast lookups to the content of the bucket, along with metadata context for each bucket item.</p>
<p>This context allows storing additional information about the S3 item. Perhaps the origin user, the destination fleet, the project, or any other tag that would be useful to know without downloading and examining the item.</p>
<p>DynamoDB is also configured to allow indexing on which documents have which keys. So, for example, it's a quick query to find out which documents in the bucket have been tagged with "configuration" as a piece of metadata about the object contents.</p>
<p>Here's the API the Document Bucket supports:</p>
<ul>
<li><code>list</code>: This operation queries DynamoDB for all entries for all items in the bucket, and their metadata. It returns the <code>set</code> of items that have been stored.</li>
<li><code>store</code>: This operation accepts a blob of bytes and a <code>map</code> of metadata context. It generates a unique identifier for the document. The identifier and associated metadata are written to DynamoDB. The bytes of the data are written to S3 under a key of that unique identifier. Any context metadata keys in DynamoDB are updated to include that new object identifier.</li>
<li><code>retrieve</code>: This operation accepts a unique identifier as an argument. First it looks that identifier up in DynamoDB and pulls the identifier and its context out. Then it retrieves that object from S3. It bundles these items together and returns them to the caller.</li>
<li><code>search</code>: This operation accepts a metadata key to search for. It then queries DynamoDB for the <code>set</code> of documents in the Document Bucket that have context matching that key. This operation then returns that set of document identifiers and their metadata.<ul>
<li>Once the desired document or documents have been identified with the returned metadata, the document identifiers can be passed to <code>retrieve</code> to actually fetch the documents.</li>
</ul>
</li>
</ul>
<p>This is a start for sharing, storing, and searching documents of a variety of types. But what about sensitive documents? Or protecting, say, important configuration files from accidental corruption during storing or retrieving?</p>
<p>Now you will add the AWS Encryption SDK to encrypt close to where the data originates: client-side encrypting the Document Bucket document before it is transmitted off of the host machine to the internet. You will use KMS to provide a <code>data key</code> for each document, using a CMK that you set up in <a href="../getting-started/">Getting Started</a> when you deployed your stacks.</p>
<h2 id="make-the-change">Make the Change</h2>
<h3 id="starting-directory">Starting Directory</h3>
<p>Make sure you are in the <code>exercises</code> directory for the language of your choice:</p>
<div class=md-fenced-code-tabs id=tab-tab-group-0><input name=tab-group-0 type=radio id=tab-group-0-0_java checked=checked class=code-tab data-lang=java aria-controls=tab-group-0-0_java-panel role=tab><label for=tab-group-0-0_java class=code-tab-label data-lang=java id=tab-group-0-0_java-label>Java</label><div class=code-tabpanel role=tabpanel data-lang=java id=tab-group-0-0_java-panel aria-labelledby=tab-group-0-0_java-label><pre><code class=java>~/environment/workshop/exercises/java
</code></pre></div><input name=tab-group-0 type=radio id=tab-group-0-1_javascript class=code-tab data-lang=javascript aria-controls=tab-group-0-1_javascript-panel role=tab><label for=tab-group-0-1_javascript class=code-tab-label data-lang=javascript id=tab-group-0-1_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-0-1_javascript-panel aria-labelledby=tab-group-0-1_javascript-label><pre><code class=javascript>~/environment/workshop/exercises/node-javascript
</code></pre></div><input name=tab-group-0 type=radio id=tab-group-0-2_python class=code-tab data-lang=python aria-controls=tab-group-0-2_python-panel role=tab><label for=tab-group-0-2_python class=code-tab-label data-lang=python id=tab-group-0-2_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-0-2_python-panel aria-labelledby=tab-group-0-2_python-label><pre><code class=python>~/environment/workshop/exercises/python
</code></pre></div></div>

<p><code>cd</code> into the <code>add-esdk-start</code> directory.</p>
<h3 id="step-1-add-the-esdk-dependency">Step 1: Add the ESDK Dependency</h3>
<p>Look for <code>ADD-ESDK-START</code> comments to help orient yourself in the code.</p>
<p>Start by adding the Encryption SDK dependency to the code.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-1><input name=tab-group-1 type=radio id=tab-group-1-0_javascript checked=checked class=code-tab data-lang=javascript aria-controls=tab-group-1-0_javascript-panel role=tab><label for=tab-group-1-0_javascript class=code-tab-label data-lang=javascript id=tab-group-1-0_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-1-0_javascript-panel aria-labelledby=tab-group-1-0_javascript-label><pre><code class=javascript>// Edit ./store.js

const { encryptStream, KmsKeyringNode } = require(&quot;@aws-crypto/client-node&quot;);

// Save and exit

// Edit ./retrieve.js

const { decryptStream, KmsKeyringNode } = require(&quot;@aws-crypto/client-node&quot;);

// Save and exit
</code></pre></div><input name=tab-group-1 type=radio id=tab-group-1-1_python class=code-tab data-lang=python aria-controls=tab-group-1-1_python-panel role=tab><label for=tab-group-1-1_python class=code-tab-label data-lang=python id=tab-group-1-1_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-1-1_python-panel aria-labelledby=tab-group-1-1_python-label><pre><code class=python># Edit src/document_bucket/__init__.py

import aws_encryption_sdk

# Save and exit
# Edit src/document_bucket/api.py

# ADD-ESDK-START
import aws_encryption_sdk
from aws_encryption_sdk import KMSMasterKeyProvider

# Add a Master Key Provider to your __init__
# ADD-ESDK-START
def __init__(self, bucket, table, master_key_provider: KMSMasterKeyProvider):
    self.bucket = bucket
    self.table = table
    # ADD-ESDK-START
    self.master_key_provider = master_key_provider

# Save and exit
</code></pre></div></div>

<h4 id="what-just-happened">What Just Happened</h4>
<p>You just imported a dependency on the AWS Encryption SDK library in your code.</p>
<p>You also changed the API to expect that a Keyring or Master Key Provider will be passed to your code to use in <code>store</code> and <code>retrieve</code> operations.</p>
<h3 id="step-2-add-encryption-to-store">Step 2: Add Encryption to <code>store</code></h3>
<p>Now that you have the AWS Encryption SDK imported, start encrypting your data before storing it.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-2><input name=tab-group-2 type=radio id=tab-group-2-0_javascript checked=checked class=code-tab data-lang=javascript aria-controls=tab-group-2-0_javascript-panel role=tab><label for=tab-group-2-0_javascript class=code-tab-label data-lang=javascript id=tab-group-2-0_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-2-0_javascript-panel aria-labelledby=tab-group-2-0_javascript-label><pre><code class=javascript>// Edit ./store.js

const Body = fileStream.pipe(encryptStream(encryptKeyring));

// Save and exit

</code></pre></div><input name=tab-group-2 type=radio id=tab-group-2-1_python class=code-tab data-lang=python aria-controls=tab-group-2-1_python-panel role=tab><label for=tab-group-2-1_python class=code-tab-label data-lang=python id=tab-group-2-1_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-2-1_python-panel aria-labelledby=tab-group-2-1_python-label><pre><code class=python># Edit src/document_bucket/api.py

def store(self, data: bytes, context: Dict[str, str] = {}) -&gt; PointerItem:
    # ADD-ESDK-START
    encrypted_data, header = aws_encryption_sdk.encrypt(
        source=data,
        key_provider=self.master_key_provider,
    )

# Save and exit
</code></pre></div></div>

<h4 id="what-just-happened_1">What Just Happened</h4>
<p>The application just started encrypting data client-side with the AWS Encryption SDK and KMS!</p>
<p>Now, before storing data in the Document Bucket, it uses the AWS Encryption SDK to:</p>
<ol>
<li>Request a new data key using your keyring or Master Key Provider</li>
<li>Encrypt that data for you</li>
<li>Return the encrypted data in the AWS Encryption SDK message format</li>
<li>Extract the ciphertext to pass to the AWS S3 SDK to store in S3</li>
</ol>
<h3 id="step-3-add-decryption-to-retrieve">Step 3: Add Decryption to <code>retrieve</code></h3>
<p>Now that you are encrypting data before storing it, you need to decrypt it before returning it to your caller. At least for it to be useful, anyway.</p>
<p> <pre><code class=javascript>// Edit retrieve.js

  return s3
    .getObject({ Bucket, Key })
    .createReadStream()
    .pipe(decryptStream(decryptKeyring));

// Save and Exit
</code></pre></p>
<h4 id="what-just-happened_2">What Just Happened</h4>
<p> <pre><code class=python># Edit src/document_bucket/api.py

    def retrieve(
            self,
            pointer_key: str,
            expected_context_keys: Set[str] = set(),
            expected_context: Dict[str, str] = {},
    ) -&gt; DocumentBundle:
        item = self._get_pointer_item(PointerQuery.from_key(pointer_key))
        # ADD-ESDK-START
        encrypted_data = self._get_object(item)
        plaintext, header = aws_encryption_sdk.decrypt(
            source=encrypted_data, key_provider=self.master_key_provider
        )
        return DocumentBundle.from_data_and_context(
            plaintext, item.context
        )

# Save and exit
</code></pre></p>
<p>The application just started decrypting data client-side as well!</p>
<p>The data returned from S3 for <code>retrieve</code> is now encrypted. Before returning that data to the user, you added a call to the AWS Encryption SDK to decrypt the data. Under the hood, the Encryption SDK:</p>
<ol>
<li>Read the AWS Encryption SDK formatted encrypted message</li>
<li>Called KMS to request to decrypt your message's encrypted data key using the Faythe CMK</li>
<li>Used the decrypted data key to decrypt the message</li>
<li>Returned the message plaintext and Encryption SDK headers to you</li>
</ol>
<h3 id="step-4-plumb-in-your-config">Step 4: Plumb In Your Config</h3>
<p>Now that you have your dependencies declared and your code updated to encrypt and decrypt data, the final step is to pass through the configuration to the AWS Encryption SDK to start using your KMS CMKs to protect your data.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-5><input name=tab-group-5 type=radio id=tab-group-5-0_javascript checked=checked class=code-tab data-lang=javascript aria-controls=tab-group-5-0_javascript-panel role=tab><label for=tab-group-5-0_javascript class=code-tab-label data-lang=javascript id=tab-group-5-0_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-5-0_javascript-panel aria-labelledby=tab-group-5-0_javascript-label><pre><code class=javascript>
// Edit store.js

const faytheCMK = config.state.getFaytheCMK();
const encryptKeyring = new KmsKeyringNode({
  generatorKeyId: faytheCMK
});

// Save and exit

// Edit retrieve.js

const faytheCMK = config.state.getFaytheCMK();
const decryptKeyring = new KmsKeyringNode({ keyIds: [faytheCMK] });

// Save and exit
</code></pre></div><input name=tab-group-5 type=radio id=tab-group-5-1_python class=code-tab data-lang=python aria-controls=tab-group-5-1_python-panel role=tab><label for=tab-group-5-1_python class=code-tab-label data-lang=python id=tab-group-5-1_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-5-1_python-panel aria-labelledby=tab-group-5-1_python-label><pre><code class=python>
# Edit src/document_bucket/__init__.py

...

# ADD-ESDK-START
# Pull configuration of KMS resources
faythe_cmk = state[&quot;FaytheCMK&quot;]
# And the Master Key Provider configuring how to use KMS
cmk = [faythe_cmk]
mkp = aws_encryption_sdk.KMSMasterKeyProvider(key_ids=[cmk])

...

operations = DocumentBucketOperations(bucket, table, mkp)

# Save and exit
</code></pre></div></div>

<h4 id="what-just-happened_3">What Just Happened</h4>
<p>In Getting Started, you launched CloudFormation stacks for CMKs. One of these CMKs was nicknamed Faythe. As part of launching these templates, the CMK's Amazon Resource Name (ARN) was written to a configuration file on disk, the <code>state</code> variable that is loaded and parsed.</p>
<p>Now Faythe's ARN is pulled into a variable, and used to initialize a keyring or master key provider that will use the Faythe CMK. That new keyring/master key provider is passed in to your API, and you are set to start encrypting and decrypting with KMS and the Encryption SDK.</p>
<h3 id="checking-your-work">Checking Your Work</h3>
<p>Want to check your progress, or compare what you've done versus a finished example?</p>
<p>Check out the code in one of the <code>-complete</code> folders to compare.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-6><input name=tab-group-6 type=radio id=tab-group-6-0_java checked=checked class=code-tab data-lang=java aria-controls=tab-group-6-0_java-panel role=tab><label for=tab-group-6-0_java class=code-tab-label data-lang=java id=tab-group-6-0_java-label>Java</label><div class=code-tabpanel role=tabpanel data-lang=java id=tab-group-6-0_java-panel aria-labelledby=tab-group-6-0_java-label><pre><code class=java>~/environment/workshop/exercises/java/add-esdk-complete
</code></pre></div><input name=tab-group-6 type=radio id=tab-group-6-1_javascript class=code-tab data-lang=javascript aria-controls=tab-group-6-1_javascript-panel role=tab><label for=tab-group-6-1_javascript class=code-tab-label data-lang=javascript id=tab-group-6-1_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-6-1_javascript-panel aria-labelledby=tab-group-6-1_javascript-label><pre><code class=javascript>~/environment/workshop/exercises/node-javascript/add-esdk-complete/store.js
~/environment/workshop/exercises/node-javascript/add-esdk-complete/retrieve.js
</code></pre></div><input name=tab-group-6 type=radio id=tab-group-6-2_python class=code-tab data-lang=python aria-controls=tab-group-6-2_python-panel role=tab><label for=tab-group-6-2_python class=code-tab-label data-lang=python id=tab-group-6-2_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-6-2_python-panel aria-labelledby=tab-group-6-2_python-label><pre><code class=python>~/environment/workshop/exercises/python/add-esdk-complete
</code></pre></div></div>

<h2 id="try-it-out">Try it Out</h2>
<p>Now that the code is written, let's load it up and try it out.</p>
<p>If you'd like to try a finished example, use your language's <code>-complete</code> directory as described above.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-7><input name=tab-group-7 type=radio id=tab-group-7-0_javascript checked=checked class=code-tab data-lang=javascript aria-controls=tab-group-7-0_javascript-panel role=tab><label for=tab-group-7-0_javascript class=code-tab-label data-lang=javascript id=tab-group-7-0_javascript-label>Javascript</label><div class=code-tabpanel role=tabpanel data-lang=javascript id=tab-group-7-0_javascript-panel aria-labelledby=tab-group-7-0_javascript-label><pre><code class=javascript>node
list = require(&quot;./list.js&quot;)
store = require(&quot;./store.js&quot;)
list().then(console.log)
store(fs.createReadStream(&quot;./store.js&quot;)).then(console.log)
list().then(console.log)
</code></pre></div><input name=tab-group-7 type=radio id=tab-group-7-1_bash class=code-tab data-lang=bash aria-controls=tab-group-7-1_bash-panel role=tab><label for=tab-group-7-1_bash class=code-tab-label data-lang=bash id=tab-group-7-1_bash-label>Node.js CLI</label><div class=code-tabpanel role=tabpanel data-lang=bash id=tab-group-7-1_bash-panel aria-labelledby=tab-group-7-1_bash-label><pre><code class=bash>./cli.js list
./cli.js store ./store.js
./cli.js list
</code></pre></div><input name=tab-group-7 type=radio id=tab-group-7-2_python class=code-tab data-lang=python aria-controls=tab-group-7-2_python-panel role=tab><label for=tab-group-7-2_python class=code-tab-label data-lang=python id=tab-group-7-2_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-7-2_python-panel aria-labelledby=tab-group-7-2_python-label><pre><code class=python>tox -e repl
import document_bucket
ops = document_bucket.initialize()
ops.list()
ops.store(b'some data')
ops.list()
# Ctrl-D when finished to exit the REPL
</code></pre></div></div>

<h2 id="explore-further">Explore Further</h2>
<ul>
<li>TODO Retrieve</li>
<li>TODO Examine TOML files</li>
<li>TODO Generate and load files to store/retrieve</li>
</ul>
<h1 id="next-exercise">Next exercise</h1>
<p>Now that you are encrypting and decrypting, how about <a href="./multi-cmk.md">adding Multiple CMKs</a>?</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
